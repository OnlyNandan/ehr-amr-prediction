    def explain_prediction(self, data: PatientData) -> Dict:
        """
        Generate SHAP values for a prediction to explain feature contributions
        """
        try:
            # Prepare input vector (same as in predict())
            try:
                gender_enc = self.encoders["gender"].transform([data.gender])[0]
            except: 
                gender_enc = 0
                
            try:
                bact_enc = self.encoders["suspected_bacterium"].transform([data.suspected_bacterium])[0]
            except: 
                bact_enc = 0
                
            try:
                abx_enc = self.encoders["candidate_antibiotic"].transform([data.candidate_antibiotic])[0]
            except: 
                abx_enc = 0
            
            features = np.array([[
                data.age, data.wbc_count, data.prior_antibiotics_days, int(data.device_use),
                data.heart_rate, data.temperature, data.systolic_bp,
                gender_enc, bact_enc, abx_enc
            ]])
            
            # Calculate SHAP values
            shap_values = self.explainer.shap_values(features)
            
            # For binary classification, take values for class 1 (resistant)
            if isinstance(shap_values, list):
                shap_values = shap_values[1]
            
            # Create feature contribution dict
            contributions = {}
            for i, feature_name in enumerate(self.feature_names):
                contributions[feature_name] = {
                    "value": float(features[0][i]),
                    "shap_value": float(shap_values[0][i])
                }
            
            # Get base value (expected value)
            base_value = float(self.explainer.expected_value[1] if isinstance(self.explainer.expected_value, list) else self.explainer.expected_value)
            
            return {
                "base_value": base_value,
                "contributions": contributions,
                "prediction": float(self.model.predict_proba(features)[0][1])
            }
        
        except Exception as e:
            return {
                "error": str(e),
                "message": "Could not generate SHAP explanation"
            }
